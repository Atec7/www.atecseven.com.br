<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Atecseven - Corporate Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --atec-primary: #0ea5e9; --atec-dark: #0f172a; }
        * { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; margin: 0; background: #f8fafc; overflow: hidden; position: fixed; }
        .view { display: none; height: 100%; width: 100%; position: absolute; inset: 0; flex-direction: column; background: #f8fafc; }
        .view.active { display: flex; }
        #messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 6px; scroll-behavior: smooth; background: #f1f5f9; }
        .bubble { position: relative; max-width: 82%; padding: 12px 16px; border-radius: 20px; font-size: 14.5px; line-height: 1.5; box-shadow: 0 2px 4px rgba(15, 23, 42, 0.04); cursor: pointer; transition: transform 0.1s; }
        .bubble-in { background: #ffffff; align-self: flex-start; border-bottom-left-radius: 4px; color: #1e293b; border: 1px solid #e2e8f0; }
        .bubble-out { background: var(--atec-primary); align-self: flex-end; border-bottom-right-radius: 4px; color: #ffffff; }
        .dots-trigger { position: absolute; top: 4px; right: -28px; color: #94a3b8; font-size: 20px; padding: 4px; opacity: 1; }
        @media (min-width: 1024px) { .bubble { max-width: 50%; } .dots-trigger { opacity: 0; } .bubble:hover .dots-trigger { opacity: 1; } }
        .reply-card { background: rgba(0,0,0,0.06); border-left: 3px solid var(--atec-primary); padding: 6px 10px; border-radius: 8px; margin-bottom: 8px; font-size: 12px; opacity: 0.8; }
        #ctx-menu { position: fixed; background: white; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); z-index: 1000; display: none; min-width: 160px; border: 1px solid #e2e8f0; overflow: hidden; }
        .menu-item { padding: 12px 16px; font-size: 14px; font-weight: 600; cursor: pointer; color: #475569; }
        .menu-item:hover { background: #f1f5f9; color: var(--atec-primary); }
    </style>
</head>
<body>

<div id="ctx-menu">
    <div class="menu-item" onclick="prepareReply()">Responder</div>
    <div class="menu-item text-red-500" onclick="deleteMessage()">Apagar</div>
</div>

<div id="v-login" class="view active items-center justify-center bg-[#0f172a]">
    <div class="w-full max-w-[340px] p-8 bg-white rounded-[32px] shadow-2xl">
        <div class="text-center mb-8">
            <h1 class="text-2xl font-800 text-slate-900 tracking-tighter uppercase">Atec<span class="text-sky-500">seven</span></h1>
            <p class="text-slate-400 text-xs font-semibold mt-1">SISTEMA DE COMUNICAÇÃO</p>
        </div>
        <input type="text" id="username" placeholder="Seu nome ou admin" class="w-full p-4 bg-slate-50 rounded-2xl mb-4 outline-none border-2 border-transparent focus:border-sky-500 transition-all font-semibold">
        <button onclick="login()" class="w-full bg-sky-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-sky-200 active:scale-95 transition-all uppercase tracking-widest text-sm">Entrar</button>
    </div>
</div>

<div id="v-admin" class="view">
    <header class="p-6 bg-white border-b flex justify-between items-center">
        <h2 class="text-xl font-800 text-slate-900">Conversas</h2>
        <button onclick="location.reload()" class="bg-slate-100 p-2 rounded-xl"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg></button>
    </header>
    <div id="user-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
</div>

<div id="v-chat" class="view">
    <header class="h-[70px] px-4 bg-white border-b flex items-center gap-3 shrink-0 z-50 shadow-sm">
        <button onclick="voltar()" id="btn-voltar" class="p-2 text-slate-400">❮</button>
        <div class="w-10 h-10 rounded-full bg-sky-500 text-white flex items-center justify-center font-bold text-lg" id="chat-avatar">A</div>
        <div class="flex-1 min-w-0">
            <h3 class="font-bold text-slate-900 text-sm truncate" id="chat-title">Suporte</h3>
            <div class="flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span><span class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">Conectado</span></div>
        </div>
    </header>

    <div id="messages"></div>

    <div id="reply-box" class="hidden bg-white border-l-[6px] border-sky-500 p-3 flex justify-between items-center shrink-0 shadow-inner">
        <div class="truncate mr-4">
            <p class="text-[10px] font-800 text-sky-500 uppercase">Respondendo</p>
            <p class="text-xs text-slate-500 truncate italic" id="reply-content"></p>
        </div>
        <button onclick="cancelReply()" class="p-2 text-slate-300">✕</button>
    </div>

    <footer class="p-3 bg-white border-t flex items-center gap-2 shrink-0 pb-[max(12px,env(safe-area-inset-bottom))]">
        <label class="p-2 text-slate-400 hover:text-sky-500 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <input type="file" class="hidden" accept="image/*" onchange="uploadImg(this)">
        </label>
        <input type="text" id="msg-input" placeholder="Digite sua mensagem..." class="flex-1 bg-slate-100 p-3 rounded-2xl outline-none text-sm font-medium focus:ring-2 focus:ring-sky-100 transition-all">
        <button onclick="enviar()" class="bg-sky-500 text-white p-3 rounded-2xl shadow-lg shadow-sky-100 active:scale-90 transition-all">
            <svg class="w-5 h-5 fill-current rotate-90" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
        </button>
    </footer>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCSeSmkMM_4-NlLv8Js_ODwA4H372yq48k",
        authDomain: "rnc-sgt.firebaseapp.com",
        databaseURL: "https://rnc-sgt-default-rtdb.firebaseio.com",
        projectId: "rnc-sgt",
        storageBucket: "rnc-sgt.firebasestorage.app",
        messagingSenderId: "500336948308",
        appId: "1:500336948308:web:a6448b9141974f542ce9c1",
        measurementId: "G-LB9EQPJRQ1"
    };

    const IMGBB_KEY = "95bb16ee776d7e20f26857cec98bd372"; 

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = "", chatID = "", isAdmin = false, msgRefId = "", msgRefText = "", replyActive = null;

    function login() {
        const val = document.getElementById('username').value.trim();
        if(!val) return;
        user = val; isAdmin = (val.toLowerCase() === 'admin');
        if(isAdmin) { show('v-admin'); loadUsers(); }
        else { chatID = user; abrirChat(user); }
    }

    function loadUsers() {
        db.ref('users').on('value', s => {
            const list = document.getElementById('user-list'); list.innerHTML = "";
            s.forEach(u => {
                const uData = u.val();
                list.innerHTML += `<div onclick="abrirChat('${uData.name}')" class="bg-white p-5 rounded-[24px] flex items-center justify-between border border-slate-100 shadow-sm active:bg-slate-50">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl bg-sky-100 text-sky-600 flex items-center justify-center font-bold text-xl">${uData.name[0]}</div>
                        <span class="font-bold text-slate-800">${uData.name}</span>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-300">❯</div>
                </div>`;
            });
        });
    }

    async function uploadImg(el) {
        if(!el.files[0]) return;
        const body = new FormData(); body.append("image", el.files[0]);
        try {
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body });
            const data = await res.json();
            enviar(data.data.url, 'image');
        } catch(e) { alert("Erro no upload"); }
    }

    function enviar(content = null, type = 'text') {
        const input = document.getElementById('msg-input');
        const text = content || input.value.trim();
        if(!text) return;
        db.ref('chats/' + chatID).push({
            sender: user, text: text, type: type,
            reply: replyActive,
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            ts: Date.now()
        });
        if(!isAdmin) db.ref('users/' + user).set({name: user});
        input.value = ""; cancelReply();
    }

    function abrirChat(n) {
        chatID = n; document.getElementById('chat-title').innerText = isAdmin ? n : "Suporte Atecseven";
        document.getElementById('chat-avatar').innerText = (isAdmin ? n[0] : "A").toUpperCase();
        document.getElementById('btn-voltar').style.display = isAdmin ? 'block' : 'none';
        show('v-chat'); loadMessages();
    }

    function loadMessages() {
        db.ref('chats/' + chatID).on('value', s => {
            const container = document.getElementById('messages'); container.innerHTML = "";
            s.forEach(child => {
                const d = child.val();
                const isMe = d.sender === user;
                const bubble = document.createElement('div');
                bubble.className = `bubble ${isMe ? 'bubble-out' : 'bubble-in'}`;
                bubble.ondblclick = () => setReply(d.text);
                
                let html = `<div class="dots-trigger" onclick="openMenu(event, '${child.key}', '${d.text}')">⋮</div>`;
                if(d.reply) html += `<div class="reply-card">"${d.reply}"</div>`;
                if(d.type === 'image') html += `<img src="${d.text}" class="rounded-xl max-w-full shadow-sm mb-1">`;
                else html += `<div>${d.text}</div>`;
                html += `<div class="text-[9px] mt-1 text-right opacity-60 font-bold">${d.time}</div>`;
                
                bubble.innerHTML = html;
                container.appendChild(bubble);
            });
            container.scrollTop = container.scrollHeight;
        });
    }

    function openMenu(e, id, text) {
        e.stopPropagation(); msgRefId = id; msgRefText = text;
        const menu = document.getElementById('ctx-menu');
        menu.style.display = 'block';
        let x = e.clientX > window.innerWidth - 180 ? e.clientX - 160 : e.clientX;
        menu.style.left = x + 'px';
        menu.style.top = e.clientY + 'px';
    }

    function prepareReply() { setReply(msgRefText); }
    function setReply(text) {
        replyActive = text.substring(0, 60);
        document.getElementById('reply-box').classList.remove('hidden');
        document.getElementById('reply-content').innerText = text;
        document.getElementById('msg-input').focus();
    }
    function cancelReply() { replyActive = null; document.getElementById('reply-box').classList.add('hidden'); }
    function deleteMessage() { if(confirm("Apagar mensagem?")) db.ref('chats/' + chatID + '/' + msgRefId).remove(); }
    function voltar() { show(isAdmin ? 'v-admin' : 'v-login'); }
    function show(id) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    
    document.addEventListener('click', () => document.getElementById('ctx-menu').style.display = 'none');
    document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') enviar(); };
</script>
</body>
</html>
